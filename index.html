<!doctype html>
<html>
<head>
   <meta charset="utf-8">
   <title>Bomba</title>

   <style>
      html, body {
         overflow: hidden;
         width: 100%;
         height: 100%;
         margin: 0;
         padding: 0;
      }

      #renderCanvas {
         width: 100%;
         height: 100%;
         position: absolute;
         touch-action: none;
      }
      #loader-container {
        width: 100%;
        height: 100%;
        position: absolute;
      }
      #loader {
        margin: 42%;
      }
   </style>

   <!--<script src="babylon.2.1.js"></script>-->
   <script src="https://raw.githubusercontent.com/BabylonJS/Babylon.js/master/dist/preview%20release%20-%20beta/babylon.2.2.js"></script>
   <!--<script src="hand.js"></script>
   <script src="cannon.js"></script>-->  <!-- optional physics engine -->
</head>

<body>
  <div id="loader-container">
    <img id="loader" src="loader.gif"> </img>
  </div>

  <canvas id="renderCanvas"></canvas>

  <!-- body -->
  <script type="text/javascript">

    // Get the canvas element from our HTML below
    var canvas = document.querySelector("#renderCanvas");
    var loader = document.querySelector("#loader");
    canvas.style.visibility = "hidden";

    // Load the BABYLON 3D engine
    var engine = new BABYLON.Engine(canvas, true);

    var lensEffect;

    // This begins the creation of a function that we will 'call' just after it's built
    var createScene = function () {

      // Now create a basic Babylon Scene object 
      var scene = new BABYLON.Scene(engine);

      // Change the scene background color to green.
      scene.clearColor = new BABYLON.Color3(0.2, 0.2, 0.2);

      // Create an "arc rotate" camera
      var camera = new BABYLON.ArcRotateCamera(
        "camera", 0, 1.5, 250,
        new BABYLON.Vector3.Zero(), scene
      );

      // This attaches the camera to the canvas
      camera.attachControl(canvas);

      // This creates a light, aiming 0,1,0 - to the sky.
      var light = new BABYLON.HemisphericLight("Light", new BABYLON.Vector3(0, 5, 0), scene);

      // Dim the light a small amount
      light.intensity = 2;

      lensEffect = new BABYLON.LensRenderingPipeline('lens', {
        edge_blur: 1.0,
        chromatic_aberration: 0.0,
        distortion: 0.0,
        dof_focus_distance: 200.0,
        dof_aperture: 25.0,      // set this very high for tilt-shift effect
        grain_amount: 1.0,
        dof_pentagon: true,
        dof_gain: 1.0,
        dof_threshold: 1.0,
        dof_darken: 0
      }, scene, 1.0, camera);


      var ground = BABYLON.Mesh.CreateGround("Ground", 200, 200, 10, scene);
      ground.position = BABYLON.Vector3.Zero();
      ground.material = new BABYLON.StandardMaterial("Ground Material", scene);
      ground.material.diffuseColor = new BABYLON.Color3(0, 0, 0);
      ground.material.specularColor = new BABYLON.Color4(0, 0, 0, 0);

      var box = BABYLON.Mesh.CreateBox("Box", 20, scene);
      box.position = new BABYLON.Vector3(100, 0, 100);
      box.scaling.y *= 10;

      var cuerpo, luz, fondo;
      var cuerpoIsReady = {p: false}, luzIsReady = {p: false}, fondoIsReady = {p: false};
      var cuerpoMaterial = new BABYLON.StandardMaterial(
        "Material CUERPO", scene
      );
      cuerpoMaterial.onCompiled = function() {
        cuerpoIsReady.p = true;
      };

      // // Create the "God Rays" effect (volumetric light scattering)
      // var godrays = new BABYLON.VolumetricLightScatteringPostProcess('godrays', 0.3, camera, null, 0, BABYLON.Texture.BILINEAR_SAMPLINGMODE, engine, false);

      // Load CUERPO
      BABYLON.SceneLoader.ImportMesh(
         "CUERPO", "", "aerosol.babylon", scene, function (meshes, particleSystems) {
            cuerpo = meshes[0];
            cuerpo.material = cuerpoMaterial;
            cuerpo.material.backFaceCulling = false;
            cuerpo.material.specularColor = new BABYLON.Color3(0.2, 0.2, 0.2);
            cuerpo.material.diffuseTexture = new BABYLON.Texture(
               "texture1.png", scene
            );

            cuerpo.scaling.x *= 10;
            cuerpo.scaling.y *= 10;
            cuerpo.scaling.z *= 10;

            cuerpo.refreshBoundingInfo();
            var bbox = cuerpo._boundingInfo.boundingBox;
            var d = bbox.maximumWorld.y - bbox.minimumWorld.y;
            d*=10;
            ground.position.y -= d/2;
         }
      );
      
      // Load LUZ
      BABYLON.SceneLoader.ImportMesh(
        "LUZ", "", "aerosol.babylon", scene, function (meshes, particleSystems) {

          luz = meshes[0];
          luz.scaling.x *= 10;
          luz.scaling.y *= 10;
          luz.scaling.z *= 10;

          // godrays.mesh = luz;

          luzIsReady.p = true;
        }
      );

      // Load FONDO
      BABYLON.SceneLoader.ImportMesh(
        "FONDO", "", "aerosol.babylon", scene, function (meshes, particleSystems) {

          var material = new BABYLON.StandardMaterial(
            "Texture FONDO", scene
          );

          fondo = meshes[0];
          fondo.scaling.x *= 10;
          fondo.scaling.y *= 10;
          fondo.scaling.z *= 10;
          
          fondo.material = material;
          fondo.material.backFaceCulling = false;
          fondo.material.specularColor = new BABYLON.Color3(0.2, 0.2, 0.2);
          fondo.material.diffuseColor = new BABYLON.Color3(0, 0, 0);

          fondoIsReady.p = true;
        }
      );

      loading();
      function loading () {
        if (cuerpoIsReady.p /*&& luzIsReady.p*/ && fondoIsReady.p) {
          canvas.style.visibility = "visible";
          loader.style.visibility = "hidden";
        }
        else {
          setTimeout(loading, 1);
        }
      }

      // Leave this function
      return scene;

    };  // End of createScene function


    // Now, call the createScene function that you just finished creating
    var scene = createScene();

    // Once the scene is loaded, just register a render loop to render it
    engine.runRenderLoop(function() {
        scene.render();
    });

    // Watch for browser/canvas resize events
    window.addEventListener("resize", function () {
       engine.resize();
    });

  </script>

</body>
</html>
